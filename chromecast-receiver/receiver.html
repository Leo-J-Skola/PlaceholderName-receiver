<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>StreamWeave Receiver (v2, Web Page Loader)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js"></script>
  <style>
    html,body{margin:0;padding:0;height:100%;background:#000;color:#ddd;font-family:Segoe UI,Roboto,Arial,sans-serif}
    #a,#b{position:absolute;inset:0;width:100%;height:100%;border:0;background:#000;opacity:0;transition:opacity .25s}
    .show{opacity:1}
    #splash{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#aaa;font-size:18px;}
    #status{position:absolute;left:0;right:0;bottom:0;padding:8px 12px;background:rgba(0,0,0,.75);font-size:12px;font-family:monospace;color:#0f0;}
    #debug{position:absolute;left:0;right:0;top:0;padding:8px 12px;background:rgba(0,0,0,.75);font-size:10px;font-family:monospace;color:#888;max-height:150px;overflow-y:auto;}
  </style>
</head>
<body>
  <div id="splash">
    <div style="margin-bottom:20px;font-size:24px;">StreamWeave Receiver</div>
    <div style="color:#666;">Waiting for URL...</div>
  </div>
  <iframe id="a" allow="autoplay; fullscreen"></iframe>
  <iframe id="b" allow="autoplay; fullscreen"></iframe>
  <div id="debug"></div>
  <div id="status"></div>
  <script>
    var NAMESPACE = 'urn:x-cast:streamweave.cast';
    var DEBUG = true; // Enable debug logging
    
    var statusEl = document.getElementById('status');
    var debugEl = document.getElementById('debug');
    var splashEl = document.getElementById('splash');
    var a = document.getElementById('a');
    var b = document.getElementById('b');
    var current = a;
    var candidate = b;
    
    var messageCount = 0;
    var castReceiverManager = null;
    var messageBus = null;
    
    function log(msg, isError) {
      var timestamp = new Date().toLocaleTimeString();
      var prefix = '[' + timestamp + ']';
      var line = prefix + ' ' + msg;
      
      console.log(line);
      
      if (DEBUG) {
        debugEl.innerHTML += line + '<br>';
        debugEl.scrollTop = debugEl.scrollHeight;
      }
      
      if (isError) {
        statusEl.style.color = '#f00';
      }
    }
    
    function setStatus(s) { 
      statusEl.textContent = s || ''; 
      log('Status: ' + s);
    }
    
    function swap() {
      candidate.classList.add('show');
      current.classList.remove('show');
      var t = current; 
      current = candidate; 
      candidate = t;
    }
    
    function loadInIframe(url) {
      log('Loading in iframe: ' + url);
      setStatus('Loading: ' + url);
      splashEl.style.display = 'none';
      candidate.classList.remove('show');
      candidate.src = 'about:blank';
      
      setTimeout(function() {
        candidate.onload = function() {
          log('Iframe loaded successfully');
          setStatus('Loaded: ' + url);
          swap();
          candidate.onload = null;
        };
        candidate.onerror = function() {
          log('Iframe failed to load', true);
          setStatus('Error loading: ' + url);
        };
        candidate.src = url;
      }, 0);
    }
    
    function forceNavigate(url) {
      log('Force navigating to: ' + url);
      setStatus('Force loading: ' + url);
      splashEl.style.display = 'none';
      setTimeout(function() { 
        window.location.href = url; 
      }, 250);
    }
    
    log('=== StreamWeave Receiver Starting ===');
    log('Namespace: ' + NAMESPACE);
    log('Cast SDK version: ' + (cast.receiver.VERSION || 'unknown'));
    
    try {
      cast.receiver.logger.setLevelValue(cast.receiver.LoggerLevel.DEBUG);
      log('Cast logger configured');
    } catch (e) {
      log(' Could not configure logger: ' + e.message);
    }
    
    try {
      castReceiverManager = cast.receiver.CastReceiverManager.getInstance();
      log('Got CastReceiverManager instance');
      
      castReceiverManager.onReady = function(event) {
        log('Cast Receiver is READY    ');
        setStatus('Ready - Waiting for LOAD_URL message');
      };
      
      castReceiverManager.onSenderConnected = function(event) {
        log('Sender connected: ' + event.senderId);
      };
      
      castReceiverManager.onSenderDisconnected = function(event) {
        log('Sender disconnected: ' + event.senderId);
      };
      
      log('Getting message bus for namespace: ' + NAMESPACE);
      messageBus = castReceiverManager.getCastMessageBus(NAMESPACE);
      log('Message bus created');
      
      messageBus.onMessage = function(event) {
        messageCount++;
        log('=== MESSAGE RECEIVED (#' + messageCount + ') ===');
        log('From sender: ' + (event.senderId || 'unknown'));
        log('Raw data: ' + event.data);
        
        try {
          var data = event && event.data ? JSON.parse(event.data) : {};
          log('Parsed type: ' + (data.type || 'none'));
          
          if (!data || data.type !== 'LOAD_URL') {
            log(' Not a LOAD_URL message (type: ' + data.type + ')');
            setStatus('Received unknown message type: ' + data.type);
            return;
          }
          
          if (!data.url) {
            log('LOAD_URL missing url field', true);
            setStatus('Error: LOAD_URL missing url');
            return;
          }
          
          var url = String(data.url);
          log('Valid LOAD_URL for: ' + url);
          
          var useForce = (typeof data.force === 'boolean') ? data.force : false;
          log('Force mode: ' + useForce);
          
          var response = JSON.stringify({ ok: true, url: url });
          log('Sending ACK: ' + response);
          messageBus.send(event.senderId, response);
          log('ACK sent');
          
          if (useForce) {
            forceNavigate(url);
          } else {
            loadInIframe(url);
          }
          
        } catch (ex) {
          log('Error processing message: ' + (ex.message || ex), true);
          setStatus('Error: ' + (ex.message || ex));
        }
      };
      
      log('Message handler registered');
      
      log('Starting Cast Receiver Manager...');
      castReceiverManager.start({ 
        statusText: 'StreamWeave Receiver Ready',
        maxInactivity: 3600 
      });
      log('Cast Receiver Manager started    ');
      setStatus('Receiver started - waiting for messages');
      
    } catch (ex) {
      log('FATAL ERROR: ' + (ex.message || ex), true);
      setStatus('Fatal error: ' + (ex.message || ex));
      splashEl.innerHTML = '<div style="color:#f00;">Error: ' + (ex.message || ex) + '</div>';
    }
    
    window.addEventListener('keydown', function(e) {
      if ((e.key || '').toLowerCase() === 'd') {
        DEBUG = !DEBUG;
        debugEl.style.display = DEBUG ? 'block' : 'none';
        log('Debug mode: ' + (DEBUG ? 'ON' : 'OFF'));
      }
    });
    
    setInterval(function() {
      if (messageCount === 0) {
        log('Heartbeat: Still waiting for first message...');
      }
    }, 10000);
    
    log('=== Initialization Complete ===');
    log('Receiver is now listening for LOAD_URL messages');
  </script>
</body>
</html>
